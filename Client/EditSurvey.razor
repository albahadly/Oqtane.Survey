@namespace Oqtane.Survey
@inherits ModuleBase

@using Oqtane.Modules.Controls
@using Oqtane.Survey.Services
@using Oqtane.Survey.Models

@inject ISurveyService SurveyService
@inject NavigationManager NavigationManager

@strError
<RadzenCard Style="margin-bottom: 20px;">
    <div class="row">
        <div class="col-md-12">
            <div>Survey Name:</div>
            <RadzenTextBox @bind-Value="Survey.SurveyName" Style="width: 400px" />
            <br />
        </div>
    </div>
</RadzenCard>
<RadzenButton Click="UpdateSurvey"
              Text="Save" ButtonStyle="ButtonStyle.Success"
              Style="margin-bottom: 10px; width: 150px" />
@if (Survey.SurveyId > 0)
{
    <ActionDialog Header="Delete Survey"
                  Message="@("Are You Sure You Wish To Delete The Survey?")"
                  Action="Delete" Security="SecurityAccessLevel.Edit"
                  Class="btn btn-danger"
                  OnClick="@(async () => await DeleteSurvey())" />
}
@code {
    #region Control Definition
    // This control can only be reached by users with Edit permission
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;

    // This control responds to the Add or Edit ActionLink commands
    public override string Actions => "EditSurvey";

    // Title for the control
    public override string Title => "Edit Survey";

    public override List<Resource> Resources => new List<Resource>()
    {
        new Resource { ResourceType = ResourceType.Stylesheet, Url = ModulePath() + "Module.css" }
    };
    #endregion

    string strError = "";
    Survey Survey = new Survey();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Survey = await SurveyService.GetSurveyAsync(ModuleState.ModuleId);

            if (Survey == null)
            {
                Survey = new Survey();
                Survey.SurveyId = -1; // So we kno wthis is a new Survey
                Survey.ModuleId = ModuleState.ModuleId;
                Survey.SurveyName = "New Survey";
            }
        }
        catch (Exception ex)
        {
            if (Survey == null)
            {
                Survey = new Survey();
                Survey.SurveyId = -1;
            }

            await logger.LogError(ex, "Error Loading Survey {SurveyId} {Error}", Survey.SurveyId, ex.Message);
            AddModuleMessage("Error Loading Survey", MessageType.Error);
        }
    }

    async Task UpdateSurvey()
    {
        try
        {
            if (Survey.SurveyId == -1)
            {
                // New Survey

                Survey = await SurveyService.AddSurveyAsync(Survey);
                await logger.LogInformation("Survey Added {Survey}", Survey);
            }
            else
            {
                // Update Survey

                await SurveyService.UpdateSurveyAsync(Survey);
                await logger.LogInformation("Survey Updated {Survey}", Survey);
            }

            // Get URL for Edit control
            string strEditURL = EditUrl("Edit");
            NavigationManager.NavigateTo(strEditURL);
        }
        catch (Exception ex)
        {
            strError = ex.GetBaseException().Message;
        }
    }

    private async Task DeleteSurvey()
    {
        try
        {
            await SurveyService.DeleteSurveyAsync(ModuleState.ModuleId);
            await logger.LogInformation("Survey Deleted {Survey}", Survey);
            NavigationManager.NavigateTo(NavigateUrl());
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Deleting Survey {Survey} {Error}", Survey, ex.Message);
            AddModuleMessage("Error Deleting Survey", MessageType.Error);
        }
    }
}
